# ============================================================
#  app.R — pSS Biomarker Explorer (lightweight, no Seurat)
#  Requires: app_data.rds (generated by prepare_app_data.R)
#  Deploy to shinyapps.io alongside app_data.rds
# ============================================================

library(shiny)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(DT)
library(ggrepel)
library(RColorBrewer)

# ── Load once at startup ──────────────────────────────────
message("=== Loading app_data.rds ===")
app_data <- readRDS("app_data.rds")
message("Keys in app_data: ", paste(names(app_data), collapse = ", "))

# cells_df
cells_df <- app_data$cells
if (is.null(cells_df)) stop("app_data$cells missing")
message("cells_df cols: ", paste(colnames(cells_df), collapse = ", "))

# expr_mat
expr_mat    <- app_data$expr
if (is.null(expr_mat)) stop("app_data$expr missing")
avail_genes <- rownames(expr_mat)
message("expr_mat: ", nrow(expr_mat), " genes x ", ncol(expr_mat), " cells")

# markers (old script may have named it 'disease_markers')
markers <- app_data$markers
if (is.null(markers)) markers <- app_data$disease_markers
if (is.null(markers) && file.exists("pss_vs_healthy_biomarkers.csv")) {
  message("markers not in app_data, loading from CSV")
  markers <- read.csv("pss_vs_healthy_biomarkers.csv", stringsAsFactors = FALSE)
}
if (is.null(markers)) stop("No markers found in app_data or CSV")
if (!"gene" %in% colnames(markers)) markers$gene <- rownames(markers)
message("markers: ", nrow(markers), " rows")

# all_genes
all_genes <- if (!is.null(app_data$all_genes)) app_data$all_genes else avail_genes

# disease_status: derive from batch if column missing
if (!"disease_status" %in% colnames(cells_df)) {
  if ("batch" %in% colnames(cells_df)) {
    message("Deriving disease_status from batch")
    cells_df$disease_status <- ifelse(grepl("^HC", cells_df$batch), "Healthy Control", "pSS Patient")
  } else {
    stop("Cannot find disease_status. Cols: ", paste(colnames(cells_df), collapse = ", "))
  }
}
message("disease_status: ", paste(unique(cells_df$disease_status), collapse = ", "))

# Coerce seurat_clusters to character so palette name-matching is consistent
cells_df$seurat_clusters <- as.character(cells_df$seurat_clusters)

# cluster_means
if (!is.null(app_data$cluster_means)) {
  cluster_means <- app_data$cluster_means
} else {
  message("Computing cluster_means on the fly...")
  clusters      <- sort(unique(cells_df$seurat_clusters))
  cluster_means <- sapply(clusters, function(cl) {
    cls <- intersect(rownames(cells_df)[as.character(cells_df$seurat_clusters) == as.character(cl)], colnames(expr_mat))
    Matrix::rowMeans(expr_mat[, cls, drop = FALSE])
  })
  colnames(cluster_means) <- paste0("Cluster_", clusters)
}

# disease_means
if (!is.null(app_data$disease_means)) {
  disease_means <- app_data$disease_means
} else {
  message("Computing disease_means on the fly...")
  pss_cells     <- intersect(rownames(cells_df)[cells_df$disease_status == "pSS Patient"],     colnames(expr_mat))
  healthy_cells <- intersect(rownames(cells_df)[cells_df$disease_status == "Healthy Control"], colnames(expr_mat))
  disease_means <- data.frame(
    pSS_Patient     = Matrix::rowMeans(expr_mat[, pss_cells,     drop = FALSE]),
    Healthy_Control = Matrix::rowMeans(expr_mat[, healthy_cells, drop = FALSE])
  )
}
message("=== Data loaded successfully ===")

# ── Colour palettes ───────────────────────────────────────
disease_pal <- c("pSS Patient" = "#c0392b", "Healthy Control" = "#2980b9")
cluster_pal <- setNames(
  colorRampPalette(brewer.pal(12, "Paired"))(length(unique(cells_df$seurat_clusters))),
  sort(unique(as.character(cells_df$seurat_clusters)))
)

# ── Dark ggplot2 theme ────────────────────────────────────
theme_dark_pss <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
  theme(
    text              = element_text(family = "sans", color = "#c9d1d9"),
    plot.background   = element_rect(fill = "#161b22", color = NA),
    panel.background  = element_rect(fill = "#0d1117", color = NA),
    panel.grid.major  = element_line(color = "#21262d", linewidth = 0.4),
    panel.grid.minor  = element_blank(),
    axis.text         = element_text(color = "#8b949e", size = 9),
    axis.title        = element_text(color = "#8b949e", size = 10),
    plot.title        = element_text(color = "#c9d1d9", size = 12, face = "bold"),
    legend.background = element_rect(fill = "#161b22", color = NA),
    legend.text       = element_text(color = "#8b949e", size = 9),
    legend.title      = element_text(color = "#8b949e", size = 9),
    strip.text        = element_text(color = "#58a6ff", size = 9)
  )
}

# ── UI ────────────────────────────────────────────────────
ui <- fluidPage(
  tags$head(
    tags$style(HTML("
      @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap');
      * { box-sizing: border-box; }
      body { font-family: 'IBM Plex Sans', sans-serif; background: #0d1117; color: #c9d1d9; margin: 0; }

      .top-bar { background: #161b22; border-bottom: 1px solid #30363d; padding: 14px 28px; display: flex; align-items: center; gap: 14px; }
      .top-bar .logo { font-family: 'IBM Plex Mono', monospace; font-weight: 600; font-size: 15px; color: #58a6ff; letter-spacing: 0.04em; }
      .top-bar .subtitle { font-size: 12px; color: #8b949e; font-family: 'IBM Plex Mono', monospace; }
      .top-bar .badge { margin-left: auto; background: #1f6feb22; border: 1px solid #1f6feb66; color: #58a6ff; font-size: 11px; font-family: 'IBM Plex Mono', monospace; padding: 3px 10px; border-radius: 20px; }

      .nav-tabs { background: #161b22; border-bottom: 1px solid #30363d; padding: 0 28px; margin: 0; }
      .nav-tabs > li > a { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #8b949e !important; border: none !important; border-bottom: 2px solid transparent !important; background: transparent !important; padding: 12px 18px; letter-spacing: 0.05em; border-radius: 0 !important; margin: 0; }
      .nav-tabs > li.active > a, .nav-tabs > li > a:hover { color: #58a6ff !important; border-bottom: 2px solid #58a6ff !important; background: transparent !important; }
      .tab-content { padding: 24px 28px; }

      .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 18px; }
      .card h4 { font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 600; color: #58a6ff; letter-spacing: 0.08em; text-transform: uppercase; margin: 0 0 14px 0; border-bottom: 1px solid #21262d; padding-bottom: 10px; }

      .stat-row { display: flex; gap: 16px; margin-bottom: 18px; }
      .stat-box { flex: 1; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px 16px; text-align: center; }
      .stat-num { font-family: 'IBM Plex Mono', monospace; font-size: 38px; font-weight: 600; line-height: 1; margin-bottom: 6px; }
      .stat-label { font-size: 11px; color: #8b949e; letter-spacing: 0.06em; text-transform: uppercase; }

      .well { background: #161b22 !important; border: 1px solid #30363d !important; border-radius: 8px !important; padding: 18px !important; box-shadow: none !important; }
      .well h4 { font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 600; color: #58a6ff; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 16px; }
      label { font-size: 12px; color: #8b949e; font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.03em; }
      .selectize-control .selectize-input, .selectize-dropdown, select.form-control, input[type=number] { background: #0d1117 !important; border: 1px solid #30363d !important; color: #c9d1d9 !important; font-family: 'IBM Plex Mono', monospace !important; font-size: 12px !important; border-radius: 6px !important; }
      .selectize-dropdown { z-index: 9999; }
      .selectize-dropdown .option { color: #c9d1d9; }
      .selectize-dropdown .option:hover, .selectize-dropdown .option.active { background: #21262d; }
      .irs--shiny .irs-bar { background: #58a6ff; border-color: #58a6ff; }
      .irs--shiny .irs-handle { background: #58a6ff; border-color: #58a6ff; }
      .irs--shiny .irs-from, .irs--shiny .irs-to, .irs--shiny .irs-single { background: #58a6ff; font-size: 10px; }
      .irs--shiny .irs-line { background: #30363d; }
      .irs--shiny .irs-min, .irs--shiny .irs-max { color: #8b949e; font-size: 10px; }
      .radio label, .checkbox label { color: #c9d1d9; font-size: 12px; }
      hr { border-color: #21262d; margin: 14px 0; }

      .dataTables_wrapper { color: #c9d1d9; font-size: 12px; font-family: 'IBM Plex Mono', monospace; }
      table.dataTable { background: #0d1117 !important; color: #c9d1d9 !important; }
      table.dataTable thead th { background: #161b22 !important; color: #58a6ff !important; border-color: #30363d !important; }
      table.dataTable tbody tr { background: #0d1117 !important; }
      table.dataTable tbody tr:hover td { background: #161b2280 !important; }
      table.dataTable td { border-color: #21262d !important; }
      .dataTables_filter input, .dataTables_length select { background: #161b22 !important; color: #c9d1d9 !important; border: 1px solid #30363d !important; border-radius: 4px; }
      .dataTables_info, .dataTables_paginate { color: #8b949e !important; }
      .paginate_button { color: #8b949e !important; }
      .paginate_button.current { background: #21262d !important; color: #58a6ff !important; border-radius: 4px; }
    "))
  ),

  div(class = "top-bar",
    div(class = "logo", "PSS-BIOMARKER-EXPLORER"),
    div(class = "subtitle", "GSE157278 · scRNA-seq · Sjögren's Syndrome"),
    div(style = "margin-left: auto; display: flex; align-items: center; gap: 10px;",
      tags$a(href = "https://github.com/mrugakshi77/pSS_scRNA_biomarker_discovery",
        target = "_blank",
        style = "background:#1f6feb22; border:1px solid #1f6feb66; color:#58a6ff; font-size:11px; font-family:\'IBM Plex Mono\', monospace; padding:3px 10px; border-radius:20px; text-decoration:none;",
        "⌥ GitHub"
      ),
      tags$a(href = "https://www.linkedin.com/in/mrugakshi-chidrawar-827127179/",
        target = "_blank",
        style = "background:#0a66c022; border:1px solid #0a66c066; color:#58a6ff; font-size:11px; font-family:\'IBM Plex Mono\', monospace; padding:3px 10px; border-radius:20px; text-decoration:none;",
        "LinkedIn"
      ),
      tags$a(href = "https://mrugakshi77.github.io/",
        target = "_blank",
        style = "background:#3fb95022; border:1px solid #3fb95066; color:#3fb950; font-size:11px; font-family:\'IBM Plex Mono\', monospace; padding:3px 10px; border-radius:20px; text-decoration:none;",
        "↗ Website"
      )
    )
  ),

  tabsetPanel(id = "main_tabs",

    # ── OVERVIEW ──
    tabPanel("OVERVIEW",
      div(class = "stat-row",
        div(class = "stat-box", div(class = "stat-num", style = "color:#58a6ff", textOutput("n_cells")),     div(class = "stat-label", "cells (post-QC)")),
        div(class = "stat-box", div(class = "stat-num", style = "color:#3fb950", textOutput("n_clusters")),  div(class = "stat-label", "cell clusters")),
        div(class = "stat-box", div(class = "stat-num", style = "color:#f78166", textOutput("n_markers")),   div(class = "stat-label", "sig. biomarkers")),
        div(class = "stat-box", div(class = "stat-num", style = "color:#d2a8ff", textOutput("n_genes")),     div(class = "stat-label", "genes available"))
      ),
      fluidRow(
        column(6, div(class = "card", h4("Cells by Disease Status"), plotOutput("ov_disease", height = "260px"))),
        column(6, div(class = "card", h4("Cells per Cluster"),       plotOutput("ov_cluster",  height = "260px")))
      ),
      div(class = "card", h4("About"),
        p(style = "font-size:13px; line-height:1.8; color:#8b949e;",
          "Interactive dashboard for a single-cell RNA-seq analysis of Primary Sjögren's Syndrome (pSS)
          peripheral blood immune cells vs healthy controls. Dataset: ",
          tags$a("GSE157278", href = "https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE157278",
                 target = "_blank", style = "color:#58a6ff;"), ". Pipeline: QC → LogNormalize →
          HVG selection → PCA (30 PCs) → UMAP → Louvain clustering (res 0.5) → FindMarkers.
          Key finding: granzymes ", tags$strong("GZMA"), " and ", tags$strong("GZMB"),
          " are among the top upregulated genes in pSS patients, implicating cytotoxic
          lymphocyte activation in disease pathology."
        ),
        tags$hr(style = "border-color:#21262d; margin: 12px 0;"),
        div(style = "display:flex; align-items:center; gap:0; flex-wrap:wrap;",
          span(style = "font-family:\'IBM Plex Mono\', monospace; font-size:12px; color:#c9d1d9; margin-right:16px;",
            "Mrugakshi Chidrawar"
          ),
          span(style = "color:#30363d; margin-right:16px; font-size:12px;", "|"),
          tags$a(href = "https://github.com/mrugakshi77/pSS_scRNA_biomarker_discovery",
            target = "_blank",
            style = "font-size:12px; color:#58a6ff; text-decoration:none; font-family:\'IBM Plex Mono\', monospace; margin-right:16px;",
            "⌥ Source Code"
          ),
          span(style = "color:#30363d; margin-right:16px; font-size:12px;", "|"),
          tags$a(href = "https://www.linkedin.com/in/mrugakshi-chidrawar-827127179/",
            target = "_blank",
            style = "font-size:12px; color:#58a6ff; text-decoration:none; font-family:\'IBM Plex Mono\', monospace; margin-right:16px;",
            "LinkedIn"
          ),
          span(style = "color:#30363d; margin-right:16px; font-size:12px;", "|"),
          tags$a(href = "https://mrugakshi77.github.io/",
            target = "_blank",
            style = "font-size:12px; color:#3fb950; text-decoration:none; font-family:\'IBM Plex Mono\', monospace;",
            "↗ mrugakshi77.github.io"
          )
        )
      )
    ),

    # ── UMAP ──
    tabPanel("UMAP",
      sidebarLayout(
        sidebarPanel(width = 3,
          h4("Display"),
          selectInput("umap_color", "Colour cells by:",
            choices  = c("Cluster" = "seurat_clusters", "Disease Status" = "disease_status", "Batch / Sample" = "batch"),
            selected = "seurat_clusters"),
          checkboxInput("umap_label", "Show cluster labels", TRUE),
          sliderInput("pt_size",  "Point size:", 0.1, 2,   0.4, 0.1),
          sliderInput("pt_alpha", "Opacity:",    0.1, 1.0, 0.7, 0.05),
          hr(),
          h4("Feature Plot"),
          selectizeInput("feat_gene", "Gene:", choices = character(0), selected = NULL,
            options = list(placeholder = "Type gene name e.g. GZMA", maxOptions = 100))
        ),
        mainPanel(width = 9,
          fluidRow(
            column(6, div(class = "card", h4("Cell Groups"),             plotOutput("umap_plot", height = "430px"))),
            column(6, div(class = "card", h4("Gene Expression on UMAP"), plotOutput("feat_plot", height = "430px")))
          )
        )
      )
    ),

    # ── BIOMARKERS ──
    tabPanel("BIOMARKERS",
      sidebarLayout(
        sidebarPanel(width = 3,
          h4("Filters"),
          sliderInput("lfc_thresh",  "Min |log2FC|:", 0,
            round(max(abs(markers$avg_log2FC), na.rm = TRUE), 1), 0.25, 0.05),
          sliderInput("pval_thresh", "Max adj. p:", 0, 1, 0.05, 0.01),
          radioButtons("direction", "Direction:",
            choices  = c("All" = "all", "Up in pSS ↑" = "up", "Down in pSS ↓" = "down"),
            selected = "all"),
          hr(),
          h4("Heatmap"),
          numericInput("top_n", "Top N genes:", 20, 5, 50)
        ),
        mainPanel(width = 9,
          tabsetPanel(
            tabPanel("Table",     br(), DTOutput("marker_tbl")),
            tabPanel("Volcano",   div(class = "card", plotOutput("volcano",      height = "500px"))),
            tabPanel("Heatmap — Disease",  div(class = "card", plotOutput("hmap_disease", height = "560px"))),
            tabPanel("Heatmap — Clusters", div(class = "card", plotOutput("hmap_cluster", height = "560px")))
          )
        )
      )
    ),

    # ── GENE EXPLORER ──
    tabPanel("GENE EXPLORER",
      sidebarLayout(
        sidebarPanel(width = 3,
          h4("Genes"),
          selectizeInput("vln_genes", "Select genes (max 6):", choices = character(0),
            selected = NULL, multiple = TRUE,
            options  = list(maxItems = 6, placeholder = "Type gene name e.g. GZMA", maxOptions = 100)),
          selectInput("vln_group", "Group by:",
            choices  = c("Disease Status" = "disease_status", "Cluster" = "seurat_clusters", "Batch" = "batch"),
            selected = "disease_status"),
          checkboxInput("show_pts", "Overlay cell points", FALSE),
          hr(),
          h4("Gene–Gene Scatter"),
          selectizeInput("scatter_x", "X gene:", choices = character(0), selected = NULL,
            options = list(placeholder = "Type gene name e.g. GZMA", maxOptions = 100)),
          selectizeInput("scatter_y", "Y gene:", choices = character(0), selected = NULL,
            options = list(placeholder = "Type gene name e.g. GZMB", maxOptions = 100))
        ),
        mainPanel(width = 9,
          div(class = "card", h4("Violin Plots"), plotOutput("vln_plot",     height = "420px")),
          fluidRow(
            column(6, div(class = "card", h4("Dot Plot"),          plotOutput("dot_plot",     height = "320px"))),
            column(6, div(class = "card", h4("Gene–Gene Scatter"), plotOutput("scatter_plot", height = "320px")))
          )
        )
      )
    )
  )
)

# ── Server ────────────────────────────────────────────────
# ── Server ────────────────────────────────────────────────
server <- function(input, output, session) {

  # Helper: safely extract a gene from sparse or dense expr_mat
  get_expr <- function(gene) {
    as.numeric(expr_mat[gene, ])
  }

  # ── Populate gene dropdowns via server-side selectize ──
  observe({
    genes <- rownames(expr_mat)
    updateSelectizeInput(session, "feat_gene",
      choices = genes, selected = "GZMA", server = TRUE)
    updateSelectizeInput(session, "vln_genes",
      choices = genes, selected = c("GZMA", "GZMB"), server = TRUE)
    updateSelectizeInput(session, "scatter_x",
      choices = genes, selected = "GZMA", server = TRUE)
    updateSelectizeInput(session, "scatter_y",
      choices = genes, selected = "GZMB", server = TRUE)
  })

  # ── Overview ──
  output$n_cells    <- renderText(nrow(cells_df))
  output$n_clusters <- renderText(length(unique(cells_df$seurat_clusters)))
  output$n_markers  <- renderText(sum(markers$p_val_adj < 0.05, na.rm = TRUE))
  output$n_genes    <- renderText(nrow(expr_mat))

  output$ov_disease <- renderPlot(bg = "transparent", {
    df <- as.data.frame(table(cells_df$disease_status))
    colnames(df) <- c("Status", "Count")
    ggplot(df, aes(Status, Count, fill = Status)) +
      geom_col(width = 0.5, show.legend = FALSE) +
      scale_fill_manual(values = disease_pal) +
      labs(x = NULL, y = "Cells") + theme_dark_pss()
  })

  output$ov_cluster <- renderPlot(bg = "transparent", {
    df <- as.data.frame(table(cells_df$seurat_clusters))
    colnames(df) <- c("Cluster", "Count")
    ggplot(df, aes(Cluster, Count, fill = Cluster)) +
      geom_col(show.legend = FALSE) +
      scale_fill_manual(values = cluster_pal) +
      labs(x = "Cluster", y = "Cells") + theme_dark_pss()
  })

  # ── UMAP ──
  output$umap_plot <- renderPlot(bg = "transparent", {
    col_var <- input$umap_color
    df      <- cells_df
    df[[col_var]] <- as.character(df[[col_var]])

    p <- ggplot(df, aes(x = UMAP_1, y = UMAP_2, color = .data[[col_var]])) +
      geom_point(size = input$pt_size, alpha = input$pt_alpha) +
      labs(color = col_var) + theme_dark_pss()

    if (col_var == "disease_status")
      p <- p + scale_color_manual(values = disease_pal)
    if (col_var == "seurat_clusters")
      p <- p + scale_color_manual(values = cluster_pal)

    if (input$umap_label && col_var == "seurat_clusters") {
      ctr <- df %>%
        group_by(seurat_clusters) %>%
        summarise(UMAP_1 = median(UMAP_1), UMAP_2 = median(UMAP_2), .groups = "drop")
      p <- p + geom_label(
        data = ctr,
        aes(x = UMAP_1, y = UMAP_2, label = seurat_clusters),
        color = "white", fill = "#161b2299", size = 3.5,
        fontface = "bold", label.padding = unit(0.15, "lines"),
        inherit.aes = FALSE
      )
    }
    p
  })

  output$feat_plot <- renderPlot(bg = "transparent", {
    gene <- input$feat_gene
    req(gene, nrow(expr_mat) > 0, gene %in% rownames(expr_mat))
    df        <- cells_df
    df$expr   <- get_expr(gene)
    df        <- df[order(df$expr), ]
    ggplot(df, aes(x = UMAP_1, y = UMAP_2, color = expr)) +
      geom_point(size = input$pt_size, alpha = input$pt_alpha) +
      scale_color_gradientn(
        colors = c("#161b22", "#21262d", "#f0e68c", "#e74c3c"),
        name   = paste0(gene, "\n(log-norm)")
      ) +
      labs(title = gene) + theme_dark_pss()
  })

  # ── Biomarkers ──
  filt_markers <- reactive({
    dm <- markers[abs(markers$avg_log2FC) >= input$lfc_thresh &
                  markers$p_val_adj       <= input$pval_thresh, ]
    if (input$direction == "up")   dm <- dm[dm$avg_log2FC >  0, ]
    if (input$direction == "down") dm <- dm[dm$avg_log2FC <  0, ]
    dm[order(dm$avg_log2FC, decreasing = TRUE), ]
  })

  output$marker_tbl <- renderDT({
    df <- filt_markers()[, c("gene", "avg_log2FC", "pct.1", "pct.2", "p_val_adj")]
    df$avg_log2FC <- round(df$avg_log2FC, 3)
    df$pct.1      <- round(df$pct.1, 3)
    df$pct.2      <- round(df$pct.2, 3)
    df$p_val_adj  <- formatC(df$p_val_adj, format = "e", digits = 2)
    colnames(df)  <- c("Gene", "Avg log2FC", "pct (pSS)", "pct (HC)", "Adj. p-value")
    datatable(df, rownames = FALSE, options = list(pageLength = 15, scrollX = TRUE))
  })

  output$volcano <- renderPlot(bg = "transparent", {
    dm <- markers
    dm$sig <- dplyr::case_when(
      dm$p_val_adj < 0.05 & dm$avg_log2FC >= 0.25  ~ "Up in pSS",
      dm$p_val_adj < 0.05 & dm$avg_log2FC <= -0.25 ~ "Down in pSS",
      TRUE ~ "NS"
    )
    dm$neg_log_p <- pmin(-log10(dm$p_val_adj + 1e-300), 300)
    top_lab <- dm %>% dplyr::filter(sig != "NS") %>%
      dplyr::arrange(desc(abs(avg_log2FC))) %>% head(20)
    ggplot(dm, aes(avg_log2FC, neg_log_p, color = sig)) +
      geom_point(alpha = 0.55, size = 1) +
      geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "#30363d") +
      geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "#30363d") +
      geom_text_repel(data = top_lab, aes(label = gene), size = 3,
        color = "#c9d1d9", segment.color = "#30363d",
        box.padding = 0.3, max.overlaps = 20) +
      scale_color_manual(values = c(
        "Up in pSS"   = "#f78166",
        "Down in pSS" = "#58a6ff",
        "NS"          = "#30363d")) +
      labs(x = "Avg log2FC (pSS vs HC)", y = "-log10(adj. p)",
           color = NULL, title = "Volcano: pSS vs Healthy Controls") +
      theme_dark_pss() + theme(legend.position = "top")
  })

  # Top N significant genes that exist in our expression matrix
  # Number of sig genes actually available (for UI feedback)
  n_sig_genes <- sum(
    !is.na(markers$p_val_adj) &
    markers$p_val_adj < 0.05 &
    markers$gene %in% rownames(expr_mat)
  )

  top_genes_r <- reactive({
    n  <- if (is.null(input$top_n) || is.na(input$top_n) || input$top_n < 1) 20 else as.integer(input$top_n)
    dm <- markers[!is.na(markers$p_val_adj) & markers$p_val_adj < 0.05, ]
    dm <- dm[order(dm$avg_log2FC, decreasing = TRUE), ]
    dm <- dm[dm$gene %in% rownames(expr_mat), ]
    # Cap at what's actually available — don't pad with non-sig genes
    head(dm$gene, min(n, nrow(dm)))
  })

  hmap_cols <- colorRampPalette(c("#1f4e79", "#0d1117", "#7f1d1d"))(50)

  output$hmap_disease <- renderPlot(bg = "transparent", {
    genes <- top_genes_r()
    req(length(genes) >= 2)

    # Compute means on the fly from expr_mat (handles sparse correctly)
    pss_cells     <- intersect(rownames(cells_df)[cells_df$disease_status == "pSS Patient"],     colnames(expr_mat))
    healthy_cells <- intersect(rownames(cells_df)[cells_df$disease_status == "Healthy Control"], colnames(expr_mat))
    mat <- cbind(
      pSS_Patient     = Matrix::rowMeans(expr_mat[genes, pss_cells,     drop = FALSE]),
      Healthy_Control = Matrix::rowMeans(expr_mat[genes, healthy_cells, drop = FALSE])
    )
    colnames(mat) <- c("pSS Patient", "Healthy Control")

    # Draw on white background so pheatmap labels are visible
    par(bg = "white", col.main = "#1a1a2e", col.lab = "#1a1a2e",
        col.axis = "#1a1a2e", fg = "#1a1a2e")
    pheatmap(mat,
      scale        = "row",
      color        = hmap_cols,
      breaks       = seq(-2, 2, length.out = 51),
      cluster_cols = FALSE,
      border_color = "white",
      fontsize_row = 9,
      fontsize_col = 11,
      fontsize     = 10,
      main         = paste0("Top ", length(genes), " pSS Biomarkers (adj.p<0.05): pSS vs Healthy")
    )
  })

  output$hmap_cluster <- renderPlot(bg = "transparent", {
    genes <- top_genes_r()
    req(length(genes) >= 2)

    # Compute cluster means on the fly from expr_mat
    clusters <- sort(unique(cells_df$seurat_clusters))
    mat <- sapply(clusters, function(cl) {
      cls <- intersect(rownames(cells_df)[cells_df$seurat_clusters == cl], colnames(expr_mat))
      Matrix::rowMeans(expr_mat[genes, cls, drop = FALSE])
    })
    colnames(mat) <- paste0("C", clusters)

    par(bg = "white", col.main = "#1a1a2e", col.lab = "#1a1a2e",
        col.axis = "#1a1a2e", fg = "#1a1a2e")
    pheatmap(mat,
      scale        = "row",
      color        = hmap_cols,
      breaks       = seq(-2, 2, length.out = 51),
      border_color = "white",
      fontsize_row = 9,
      fontsize_col = 10,
      fontsize     = 10,
      main         = paste0("Top ", length(genes), " pSS Biomarkers (adj.p<0.05) Across Clusters")
    )
  })

  # ── Gene Explorer ──
  output$vln_plot <- renderPlot(bg = "transparent", {
    genes <- input$vln_genes
    req(length(genes) >= 1)
    genes <- intersect(genes, rownames(expr_mat))
    req(length(genes) >= 1)

    grp <- input$vln_group
    df_long <- do.call(rbind, lapply(genes, function(g) {
      data.frame(
        gene  = g,
        group = as.character(cells_df[[grp]]),
        expr  = get_expr(g),
        stringsAsFactors = FALSE
      )
    }))
    df_long$gene <- factor(df_long$gene, levels = genes)

    p <- ggplot(df_long, aes(x = group, y = expr, fill = group)) +
      geom_violin(scale = "width", trim = TRUE, show.legend = FALSE) +
      facet_wrap(~gene, scales = "free_y", ncol = min(3, length(genes))) +
      labs(x = NULL, y = "Log-normalised expression") +
      theme_dark_pss() +
      theme(axis.text.x = element_text(angle = 30, hjust = 1, size = 9))

    if (grp == "disease_status")
      p <- p + scale_fill_manual(values = disease_pal)
    if (grp == "seurat_clusters")
      p <- p + scale_fill_manual(values = cluster_pal)
    if (input$show_pts)
      p <- p + geom_jitter(width = 0.15, size = 0.3, alpha = 0.3, show.legend = FALSE)
    p
  })

  output$dot_plot <- renderPlot(bg = "transparent", {
    genes <- intersect(input$vln_genes, rownames(expr_mat))
    req(length(genes) >= 1)
    grp <- input$vln_group

    df_long <- do.call(rbind, lapply(genes, function(g) {
      data.frame(
        gene  = g,
        group = as.character(cells_df[[grp]]),
        expr  = get_expr(g),
        stringsAsFactors = FALSE
      )
    }))

    dot_df <- df_long %>%
      dplyr::group_by(gene, group) %>%
      dplyr::summarise(
        mean_expr = mean(expr),
        pct_expr  = mean(expr > 0) * 100,
        .groups   = "drop"
      )

    ggplot(dot_df, aes(x = group, y = gene, size = pct_expr, color = mean_expr)) +
      geom_point() +
      scale_size_continuous(range = c(1, 8), name = "% expressed") +
      scale_color_gradientn(
        colors = c("#21262d", "#f0e68c", "#e74c3c"),
        name   = "Mean expr"
      ) +
      labs(x = NULL, y = NULL) +
      theme_dark_pss() +
      theme(axis.text.x = element_text(angle = 30, hjust = 1, size = 9))
  })

  output$scatter_plot <- renderPlot(bg = "transparent", {
    gx <- input$scatter_x
    gy <- input$scatter_y
    req(gx %in% rownames(expr_mat), gy %in% rownames(expr_mat), gx != gy)

    df      <- cells_df
    df$x    <- get_expr(gx)
    df$y    <- get_expr(gy)
    df$grp  <- df$disease_status

    ggplot(df, aes(x = x, y = y, color = grp)) +
      geom_point(size = 0.4, alpha = 0.5) +
      geom_smooth(method = "lm", se = FALSE, linewidth = 0.8, linetype = "dashed") +
      scale_color_manual(values = disease_pal) +
      labs(x = paste0(gx, " expression"), y = paste0(gy, " expression"), color = NULL) +
      theme_dark_pss() +
      theme(legend.position = "top")
  })
}

shinyApp(ui = ui, server = server)
